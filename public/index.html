<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>호산나 성가대 연습실</title>
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('/res/cover.jpg');
            background-size: cover;
            background-position: center;
            opacity: 0.08;
            z-index: 0;
        }

        /* Animated Background Circle */
        body::after {
            content: '';
            position: fixed;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            top: -300px;
            right: -300px;
            z-index: 0;
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(50px) rotate(180deg);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        /* Header with Glassmorphism */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 16px 24px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            color: white;
            font-weight: 600;
            font-size: 1.4rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        #d-day {
            background: rgba(255, 255, 255, 0.25);
            padding: 10px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #d-day:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        main {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease;
        }

        .glass-card:hover {
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
            transform: translateY(-5px);
        }

        .glass-card h2 {
            color: white;
            font-weight: 600;
            margin-bottom: 18px;
            font-size: 1.4rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        #announcement-content {
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.7;
            font-size: 1.05rem;
        }

        /* Song List */
        .song-list-item {
            display: flex;
            align-items: center;
            padding: 18px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .song-list-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(10px);
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.2);
        }

        .song-list-item .icon {
            font-size: 42px;
            color: white;
            margin-right: 18px;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2));
        }

        .song-list-item .title {
            font-size: 1.15rem;
            font-weight: 500;
            color: white;
            flex-grow: 1;
        }

        .song-list-item .material-icons:last-child {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Back Button */
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            padding: 14px 28px;
            font-weight: 500;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        #song-title {
            color: white;
            font-weight: 600;
            margin: 24px 0;
            font-size: 1.8rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Part Tabs */
        .part-tabs {
            display: flex;
            gap: 14px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .part-tab {
            flex: 1;
            min-width: 110px;
            padding: 16px 22px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            font-size: 1.05rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .part-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .part-tab.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.2));
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        /* Video Container */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 24px auto;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .video-container video,
        .video-container audio {
            width: 100%;
            display: block;
        }

        /* Custom Controls */
        .custom-controls {
            margin-top: 24px;
            padding: 26px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .control-group {
            margin-bottom: 22px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 14px;
            color: white;
            font-size: 1rem;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .control-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .control-buttons button {
            flex: 1;
            min-width: 75px;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
            font-size: 0.95rem;
        }

        .control-buttons button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .control-buttons button.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.15));
            border: 2px solid rgba(255, 255, 255, 0.4);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.25);
        }

        .loop-info {
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-top: 14px;
            font-size: 0.95rem;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Dialogs */
        .dialog {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .dialog.open {
            display: flex;
        }

        .dialog-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dialog-content h2 {
            margin-bottom: 20px;
            color: #2d3748;
            font-weight: 600;
        }

        .dialog-content input,
        .dialog-content textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .dialog-content textarea {
            min-height: 150px;
            resize: vertical;
        }

        .dialog-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .dialog-actions button {
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
        }

        .dialog-actions button.cancel {
            background: rgba(0, 0, 0, 0.05);
            color: #2d3748;
        }

        .dialog-actions button.confirm {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .dialog-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-title {
                font-size: 1.1rem;
            }

            #d-day {
                font-size: 0.95rem;
                padding: 8px 16px;
            }

            .part-tabs {
                flex-direction: column;
            }

            .part-tab {
                flex: none;
            }

            .control-buttons {
                flex-direction: column;
            }

            .control-buttons button {
                flex: none;
                width: 100%;
            }

            main {
                padding: 16px;
            }

            .glass-card {
                padding: 20px;
            }
        }

        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>

<body>

    <header>
        <div class="header-content">
            <h1 class="header-title">호산나 성가대 연습실</h1>
            <span id="d-day"></span>
        </div>
    </header>

    <main>
        <div id="announcement-container" class="glass-card">
            <h2>공지 사항</h2>
            <p id="announcement-content"></p>
        </div>

        <div id="song-list-container" class="glass-card">
            <h2>생명되신 주님, 예수!</h2>
            <ul id="song-list" style="list-style: none; padding: 0; margin: 0;"></ul>
        </div>

        <div id="song-detail-container" class="glass-card hidden">
            <button class="back-button" onclick="history.back()">
                <i class="material-icons">arrow_back</i>
                <span>목록</span>
            </button>
            <h2 id="song-title"></h2>

            <!-- Part Tabs -->
            <div id="part-tabs-container" class="part-tabs">
                <div class="part-tab" data-part="soprano">소프라노</div>
                <div class="part-tab" data-part="alto">알토</div>
                <div class="part-tab" data-part="tenor">테너</div>
                <div class="part-tab" data-part="bass">베이스</div>
            </div>

            <!-- Video Player -->
            <div id="media-container" class="video-container"></div>

            <!-- Custom Controls -->
            <div id="custom-controls" class="custom-controls">
                <div class="control-group">
                    <label>재생 속도</label>
                    <div class="control-buttons">
                        <button class="speed-btn" data-speed="0.5">0.5x</button>
                        <button class="speed-btn" data-speed="0.75">0.75x</button>
                        <button class="speed-btn active" data-speed="1">1x</button>
                        <button class="speed-btn" data-speed="1.25">1.25x</button>
                        <button class="speed-btn" data-speed="1.5">1.5x</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>구간 반복</label>
                    <div class="control-buttons">
                        <button id="set-a-btn">A 지점 설정</button>
                        <button id="set-b-btn">B 지점 설정</button>
                        <button id="toggle-loop-btn">반복 시작</button>
                        <button id="clear-loop-btn">초기화</button>
                    </div>
                    <div id="loop-info" class="loop-info hidden"></div>
                </div>
            </div>
        </div>

        <!-- Password Dialog -->
        <div id="password-dialog" class="dialog">
            <div class="dialog-content">
                <h2>관리자 비밀번호</h2>
                <input type="password" id="password-input" placeholder="비밀번호를 입력하세요">
                <div class="dialog-actions">
                    <button class="cancel" onclick="closePasswordDialog()">취소</button>
                    <button class="confirm" onclick="submitPassword()">확인</button>
                </div>
            </div>
        </div>

        <!-- Announcement Dialog -->
        <div id="announcement-dialog" class="dialog">
            <div class="dialog-content">
                <h2>공지사항 수정</h2>
                <textarea id="announcement-input" placeholder="공지사항을 입력하세요"></textarea>
                <div class="dialog-actions">
                    <button class="cancel" onclick="closeAnnouncementDialog()">취소</button>
                    <button class="confirm" onclick="saveAnnouncement()">저장</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="/__/firebase/9.6.1/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.6.1/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // D-Day 계산
            const dDayElement = document.getElementById('d-day');
            const dDay = new Date('2026-04-05');
            const today = new Date();
            dDay.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const diffTime = dDay.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
                dDayElement.textContent = `D-${diffDays}`;
            } else if (diffDays === 0) {
                dDayElement.textContent = 'D-Day';
            } else {
                dDayElement.textContent = `D+${Math.abs(diffDays)}`;
            }

            const db = firebase.firestore();
            let songs = [];
            let currentSong = null;
            let currentPart = null;
            let currentMediaElement = null;

            // Loop state
            let loopA = null;
            let loopB = null;
            let isLooping = false;
            let loopInterval = null;

            const songListContainer = document.getElementById('song-list-container');
            const songDetailContainer = document.getElementById('song-detail-container');
            const announcementContainer = document.getElementById('announcement-container');
            const announcementContent = document.getElementById('announcement-content');
            const partTabsContainer = document.getElementById('part-tabs-container');
            const mediaContainer = document.getElementById('media-container');

            function showView(viewToShow) {
                [songListContainer, songDetailContainer].forEach(view => {
                    if (view) view.classList.add('hidden');
                });
                if (viewToShow) {
                    viewToShow.classList.remove('hidden');
                    if (viewToShow === songListContainer) announcementContainer.classList.remove('hidden');
                    else announcementContainer.classList.add('hidden');
                }
            }

            function showSongList() {
                showView(songListContainer);
                stopMedia();
            }

            function showSongDetail(songId) {
                const song = songs.find(s => s.id === songId);
                if (!song) return;

                currentSong = song;
                document.getElementById('song-title').textContent = song.title;

                if (song.media.parts) {
                    partTabsContainer.classList.remove('hidden');
                    setTimeout(() => selectPart('soprano'), 100);
                } else {
                    partTabsContainer.classList.add('hidden');
                    loadFullMedia();
                }

                showView(songDetailContainer);
                history.pushState({ page: 'detail', songId: songId }, song.title);
            }

            function selectPart(partName) {
                if (!currentSong || !currentSong.media.parts) return;

                currentPart = partName;

                document.querySelectorAll('.part-tab').forEach(tab => {
                    if (tab.dataset.part === partName) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                const partData = currentSong.media.parts[partName];
                if (partData && partData.video) {
                    loadVideo(partData.video);
                }
            }

            function loadFullMedia() {
                if (!currentSong || !currentSong.media.full) return;

                mediaContainer.innerHTML = '';

                if (currentSong.media.full.video) {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.src = currentSong.media.full.video;
                    video.style.marginBottom = '16px';
                    mediaContainer.appendChild(video);
                    currentMediaElement = video;
                    setupMediaControls(video);
                }

                if (currentSong.media.full.audio) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = currentSong.media.full.audio;
                    audio.style.width = '100%';
                    mediaContainer.appendChild(audio);
                }
            }

            function loadVideo(url) {
                mediaContainer.innerHTML = '';

                const video = document.createElement('video');
                video.controls = true;
                video.src = url;
                mediaContainer.appendChild(video);

                currentMediaElement = video;
                setupMediaControls(video);
            }

            function setupMediaControls(mediaElement) {
                resetLoop();

                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.onclick = () => {
                        const speed = parseFloat(btn.dataset.speed);
                        mediaElement.playbackRate = speed;

                        document.querySelectorAll('.speed-btn').forEach(b => {
                            b.classList.toggle('active', b === btn);
                        });
                    };
                });

                document.getElementById('set-a-btn').onclick = () => setLoopPoint('A');
                document.getElementById('set-b-btn').onclick = () => setLoopPoint('B');
                document.getElementById('toggle-loop-btn').onclick = toggleLoop;
                document.getElementById('clear-loop-btn').onclick = resetLoop;
            }

            function setLoopPoint(point) {
                if (!currentMediaElement) return;

                const time = currentMediaElement.currentTime;

                if (point === 'A') {
                    loopA = time;
                } else {
                    loopB = time;
                }

                updateLoopInfo();
            }

            function toggleLoop() {
                if (!currentMediaElement || loopA === null || loopB === null) {
                    alert('A와 B 지점을 모두 설정해주세요.');
                    return;
                }

                if (loopA >= loopB) {
                    alert('B 지점이 A 지점보다 뒤에 있어야 합니다.');
                    return;
                }

                isLooping = !isLooping;
                const btn = document.getElementById('toggle-loop-btn');

                if (isLooping) {
                    btn.classList.add('active');
                    btn.textContent = '반복 중지';
                    currentMediaElement.currentTime = loopA;
                    currentMediaElement.play();

                    loopInterval = setInterval(() => {
                        if (currentMediaElement.currentTime >= loopB) {
                            currentMediaElement.currentTime = loopA;
                        }
                    }, 100);
                } else {
                    btn.classList.remove('active');
                    btn.textContent = '반복 시작';
                    if (loopInterval) {
                        clearInterval(loopInterval);
                        loopInterval = null;
                    }
                }

                updateLoopInfo();
            }

            function resetLoop() {
                loopA = null;
                loopB = null;
                isLooping = false;

                if (loopInterval) {
                    clearInterval(loopInterval);
                    loopInterval = null;
                }

                const btn = document.getElementById('toggle-loop-btn');
                btn.classList.remove('active');
                btn.textContent = '반복 시작';

                updateLoopInfo();
            }

            function updateLoopInfo() {
                const info = document.getElementById('loop-info');
                if (loopA === null && loopB === null) {
                    info.classList.add('hidden');
                } else {
                    info.classList.remove('hidden');
                    info.textContent = `A: ${formatTime(loopA)} | B: ${formatTime(loopB)} ${isLooping ? '(반복 중)' : ''}`;
                }
            }

            function formatTime(seconds) {
                if (seconds === null) return '--:--';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            function stopMedia() {
                if (currentMediaElement) {
                    currentMediaElement.pause();
                    currentMediaElement.currentTime = 0;
                }
                resetLoop();
            }

            // Part tabs event listeners
            document.querySelectorAll('.part-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    selectPart(tab.dataset.part);
                });
            });

            // Fetch songs
            db.collection("songs").orderBy("order").onSnapshot((querySnapshot) => {
                const songListEl = document.getElementById("song-list");
                songListEl.innerHTML = "";
                songs = [];

                querySnapshot.forEach((doc) => {
                    const song = { id: doc.id, ...doc.data() };
                    songs.push(song);

                    const listItem = document.createElement('li');
                    listItem.className = "song-list-item";
                    listItem.innerHTML = `
                        <i class="material-icons icon">music_note</i>
                        <div style="flex-grow: 1;">
                            <span class="title">${song.title}</span>
                        </div>
                        <i class="material-icons">chevron_right</i>
                    `;
                    listItem.onclick = () => showSongDetail(song.id);
                    songListEl.appendChild(listItem);
                });
            });

            // Fetch announcement
            db.collection('announcements').doc('latest').onSnapshot((doc) => {
                if (doc.exists) {
                    announcementContent.textContent = doc.data().content;
                    document.getElementById('announcement-input').value = doc.data().content;
                } else {
                    announcementContent.textContent = '공지사항이 없습니다.';
                }
            });

            // Admin functions
            dDayElement.addEventListener('click', () => {
                document.getElementById('password-input').value = '';
                document.getElementById('password-dialog').classList.add('open');
            });

            window.closePasswordDialog = () => {
                document.getElementById('password-dialog').classList.remove('open');
            };

            window.closeAnnouncementDialog = () => {
                document.getElementById('announcement-dialog').classList.remove('open');
            };

            window.submitPassword = () => {
                const enteredPassword = document.getElementById('password-input').value;
                db.collection('config').doc('admin').get().then(doc => {
                    if (doc.exists && doc.data().password === enteredPassword) {
                        closePasswordDialog();
                        document.getElementById('announcement-dialog').classList.add('open');
                    } else {
                        alert('비밀번호가 틀렸습니다.');
                    }
                }).catch(error => {
                    console.error("Error:", error);
                    alert('비밀번호 확인 중 오류가 발생했습니다.');
                });
            };

            window.saveAnnouncement = () => {
                const newAnnouncement = document.getElementById('announcement-input').value;
                db.collection('announcements').doc('latest').set({
                    content: newAnnouncement,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    closeAnnouncementDialog();
                }).catch(error => {
                    console.error('Error:', error);
                });
            };

            // History navigation
            history.replaceState({ page: 'list' }, 'Song List');

            window.addEventListener('popstate', (event) => {
                if (event.state) {
                    switch (event.state.page) {
                        case 'list':
                            showSongList();
                            break;
                        case 'detail':
                            if (event.state.songId) {
                                const song = songs.find(s => s.id === event.state.songId);
                                if (song) {
                                    currentSong = song;
                                    document.getElementById('song-title').textContent = song.title;
                                    if (song.media.parts) {
                                        partTabsContainer.classList.remove('hidden');
                                        selectPart('soprano');
                                    } else {
                                        partTabsContainer.classList.add('hidden');
                                        loadFullMedia();
                                    }
                                    showView(songDetailContainer);
                                }
                            }
                            break;
                        default:
                            showSongList();
                    }
                }
            });
        });
    </script>
</body>

</html>